{% extends "base.html" %}
{% block title %}Import Progress - Data Upload Portal{% endblock %}
{% block content %}
<div class="upload-container">
    <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 400px;"></div>
    
    <div class="upload-header">
        <h1>Import Progress</h1>
        <p>Tracking your data import process in real-time</p>
        {% if import_id %}
        <div class="import-id-badge">
            <i class="fas fa-tag"></i>
            Tracking ID: <strong>{{ import_id }}</strong>
        </div>
        {% endif %}
    </div>

    <!-- Progress Overview Card -->
    <div class="upload-card">
        <div class="form-section">
            <h3 class="section-title">Import Progress Overview</h3>
            
            <div class="progress-overview">
                <div class="progress-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="processedFiles">0</div>
                        <div class="stat-label">Files Processed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="successfulSteps">0</div>
                        <div class="stat-label">Completed Steps</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalSteps">3</div>
                        <div class="stat-label">Total Steps</div>
                    </div>
                </div>
                
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progressText">0% Complete</div>
                </div>

                <!-- Current Status Display -->
                <div class="current-status" id="currentStatus">
                    <i class="fas fa-info-circle"></i>
                    <span id="statusMessage">Waiting for import to start...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Steps Cards -->
    <div class="steps-container">
        <!-- Staging Step -->
        <div class="upload-card step-card" id="stagingCard">
            <div class="form-section">
                <div class="step-header">
                    <div class="file-icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="step-info">
                        <h3>Staging Import</h3>
                        <p>Upload files to staging tables</p>
                    </div>
                    <div class="step-status" id="stagingStatus">
                        <span class="status-badge status-pending">Pending</span>
                    </div>
                </div>
                
                <div class="step-details">
                    <div class="step-files" id="stagingFiles">
                        <div class="file-placeholder">No files processed yet</div>
                    </div>
                    <div class="step-log" id="stagingLog">
                        <div class="log-entry">
                            <div class="log-time">--:--:--</div>
                            <div class="log-message">Waiting to start staging import...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Final Tables Step -->
        <div class="upload-card step-card" id="finalCard">
            <div class="form-section">
                <div class="step-header">
                    <div class="file-icon">
                        <i class="fas fa-table"></i>
                    </div>
                    <div class="step-info">
                        <h3>Final Tables</h3>
                        <p>Process data to final tables</p>
                    </div>
                    <div class="step-status" id="finalStatus">
                        <span class="status-badge status-pending">Pending</span>
                    </div>
                </div>
                
                <div class="step-details">
                    <div class="step-log" id="finalLog">
                        <div class="log-entry">
                            <div class="log-time">--:--:--</div>
                            <div class="log-message">Waiting for staging to complete...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reconciliation Step -->
        <div class="upload-card step-card" id="reconciliationCard">
            <div class="form-section">
                <div class="step-header">
                    <div class="file-icon">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <div class="step-info">
                        <h3>Reconciliation</h3>
                        <p>Reconcile transaction data</p>
                    </div>
                    <div class="step-status" id="reconciliationStatus">
                        <span class="status-badge status-pending">Pending</span>
                    </div>
                </div>
                
                <div class="step-details">
                    <div class="step-log" id="reconciliationLog">
                        <div class="log-entry">
                            <div class="log-time">--:--:--</div>
                            <div class="log-message">Waiting for final tables to complete...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Import Logs -->
    <div class="upload-card">
        <div class="form-section">
            <div class="logs-header">
                <h3 class="section-title"><i class="fas fa-history"></i> Live Import Logs</h3>
                <div class="logs-controls">
                    <button onclick="refreshStatus()" class="btn-refresh" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <div class="auto-refresh-toggle">
                        <input type="checkbox" id="autoRefreshToggle" checked>
                        <label for="autoRefreshToggle">Auto-refresh</label>
                    </div>
                </div>
            </div>
            
            <div class="logs-container" id="liveLogs">
                <div class="log-entry">
                    <div class="log-time">{{ now.strftime('%H:%M:%S') if now else '--:--:--' }}</div>
                    <div class="log-message">Monitoring import progress...</div>
                </div>
            </div>
            
            <div class="logs-footer">
                <small><i class="fas fa-info-circle"></i> Logs update automatically every 3 seconds</small>
            </div>
        </div>
    </div>

    <!-- Navigation Links -->
    <div class="navigation-links">
        <a href="{{ url_for('upload') }}" class="nav-link">
            <i class="fas fa-arrow-left"></i>
            Back to Upload
        </a>
        <a href="{{ url_for('view_logs') }}" class="nav-link">
            <i class="fas fa-history"></i>
            View All Logs
        </a>
        <a href="{{ url_for('logout') }}" class="logout-link">
            <i class="fas fa-sign-out-alt"></i>
            Logout
        </a>
    </div>
</div>

<style>
/* Import ID Badge */
.import-id-badge {
    background: rgba(255, 255, 255, 0.2);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    margin-top: 10px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

/* Current Status Display */
.current-status {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: #f8fafc;
    border-radius: 12px;
    border-left: 4px solid #3b82f6;
    margin-top: 20px;
}

.current-status i {
    color: #3b82f6;
    font-size: 1.2rem;
}

#statusMessage {
    font-weight: 500;
    color: #1e293b;
}

/* Progress Specific Styles */
.progress-overview {
    display: flex;
    flex-direction: column;
    gap: 30px;
}

.progress-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
}

.stat-item {
    text-align: center;
    padding: 25px;
    background: #f8fafc;
    border-radius: 16px;
    border: 2px solid #e2e8f0;
    transition: all 0.3s ease;
}

.stat-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #3b82f6;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 1rem;
    color: #64748b;
    font-weight: 500;
}

.progress-bar-container {
    text-align: center;
}

.progress-bar {
    width: 100%;
    height: 12px;
    background: #e2e8f0;
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 15px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #3b82f6, #1d4ed8);
    border-radius: 6px;
    transition: width 0.5s ease;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.progress-text {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1e293b;
}

/* Steps Container */
.steps-container {
    display: flex;
    flex-direction: column;
    gap: 25px;
    margin-bottom: 30px;
}

/* Step Cards */
.step-card {
    transition: all 0.3s ease;
}

.step-card.active-step {
    border-left: 4px solid #3b82f6;
    background: rgba(59, 130, 246, 0.02);
}

.step-card.completed-step {
    border-left: 4px solid #10b981;
    background: rgba(16, 185, 129, 0.02);
}

.step-card.failed-step {
    border-left: 4px solid #ef4444;
    background: rgba(239, 68, 68, 0.02);
}

/* Step Header */
.step-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 25px;
}

.file-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.file-icon i {
    font-size: 1.5rem;
    color: white;
}

.step-info {
    flex: 1;
}

.step-info h3 {
    font-size: 1.5rem;
    color: #1e293b;
    margin-bottom: 8px;
    font-weight: 600;
}

.step-info p {
    color: #64748b;
    font-size: 1rem;
    margin: 0;
}

.step-status {
    flex-shrink: 0;
}

.status-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-pending {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fcd34d;
}

.status-processing {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #93c5fd;
}

.status-completed {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
}

.status-failed {
    background: #fee2e2;
    color: #dc2626;
    border: 1px solid #fecaca;
}

/* Step Details */
.step-details {
    margin-top: 20px;
}

.step-files {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
}

.file-placeholder {
    color: #64748b;
    font-style: italic;
    padding: 10px;
}

.file-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9rem;
    color: #374151;
    transition: all 0.3s ease;
}

.file-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.file-badge.success {
    background: #d1fae5;
    border-color: #a7f3d0;
    color: #065f46;
}

.file-badge.error {
    background: #fee2e2;
    border-color: #fecaca;
    color: #dc2626;
}

.file-badge.processing {
    background: #dbeafe;
    border-color: #93c5fd;
    color: #1e40af;
}

.step-log {
    max-height: 200px;
    overflow-y: auto;
    background: #f8fafc;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #e2e8f0;
}

/* Logs Section */
.logs-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.logs-controls {
    display: flex;
    gap: 15px;
    align-items: center;
}

.btn-refresh {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.3s ease;
}

.btn-refresh:hover {
    background: #2563eb;
}

.btn-refresh:disabled {
    background: #9ca3af;
    cursor: not-allowed;
}

.auto-refresh-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    color: #64748b;
}

.auto-refresh-toggle input[type="checkbox"] {
    margin: 0;
}

.logs-container {
    max-height: 300px;
    overflow-y: auto;
    background: #f8fafc;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #e2e8f0;
}

.log-entry {
    display: flex;
    gap: 15px;
    padding: 12px 0;
    border-bottom: 1px solid #e2e8f0;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

.log-entry:last-child {
    border-bottom: none;
}

.log-time {
    color: #6b7280;
    min-width: 80px;
    font-weight: 500;
    flex-shrink: 0;
}

.log-message {
    flex: 1;
    color: #374151;
}

/* Log level colors */
.log-success { color: #059669; }
.log-error { color: #dc2626; }
.log-warning { color: #d97706; }
.log-info { color: #2563eb; }

.logs-footer {
    margin-top: 15px;
    text-align: center;
    color: #6b7280;
    font-size: 0.8rem;
}

/* Alert Styles */
.alert-message {
    padding: 18px 24px;
    border-radius: 12px;
    margin-bottom: 15px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    animation: slideIn 0.4s ease;
    border-left: 4px solid;
    font-weight: 500;
}

.alert-error {
    background: #fee2e2;
    color: #dc2626;
    border-left-color: #dc2626;
}

.alert-warning {
    background: #fef3c7;
    color: #92400e;
    border-left-color: #f59e0b;
}

.alert-success {
    background: #d1fae5;
    color: #065f46;
    border-left-color: #10b981;
}

@keyframes slideIn {
    from { 
        transform: translateX(100%); 
        opacity: 0; 
    }
    to { 
        transform: translateX(0); 
        opacity: 1; 
    }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .upload-container {
        padding: 20px 15px;
    }
    
    .upload-card {
        padding: 30px 20px;
    }
    
    .upload-header h1 {
        font-size: 2.2rem;
    }
    
    .progress-stats {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .stat-item {
        padding: 20px;
    }
    
    .stat-value {
        font-size: 2rem;
    }
    
    .step-header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .file-icon {
        width: 50px;
        height: 50px;
    }
    
    .logs-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }
    
    .logs-controls {
        width: 100%;
        justify-content: space-between;
    }
    
    .navigation-links {
        flex-direction: column;
        align-items: center;
    }
    
    .log-entry {
        flex-direction: column;
        gap: 5px;
    }
    
    .log-time {
        min-width: auto;
    }
}
</style>

<script>
// Import progress tracking functionality
let currentImportId = "{{ import_id }}";
let refreshInterval = null;
let autoRefresh = true;

// Show alert message at top
function showAlert(message, type = 'error') {
    const alertContainer = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert-message alert-${type}`;
    alert.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>
            <span style="flex: 1;">${message}</span>
        </div>
    `;
    
    alertContainer.appendChild(alert);
    
    // Remove alert after 5 seconds
    setTimeout(() => {
        alert.style.opacity = '0';
        alert.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (alert.parentNode) {
                alert.parentNode.removeChild(alert);
            }
        }, 500);
    }, 5000);
}

// Update progress display
function updateProgressDisplay(processedFiles, completedSteps, totalSteps, progressPercentage) {
    document.getElementById('processedFiles').textContent = processedFiles;
    document.getElementById('successfulSteps').textContent = completedSteps;
    document.getElementById('totalSteps').textContent = totalSteps;
    document.getElementById('progressFill').style.width = `${progressPercentage}%`;
    document.getElementById('progressText').textContent = `${Math.round(progressPercentage)}% Complete`;
}

// Update step status
function updateStepStatus(stepId, status, message = '') {
    const stepCard = document.getElementById(`${stepId}Card`);
    const statusElement = document.getElementById(`${stepId}Status`);
    
    stepCard.classList.remove('active-step', 'completed-step', 'failed-step');
    statusElement.innerHTML = '';
    
    let statusBadge = '';
    switch(status) {
        case 'pending':
            statusBadge = '<span class="status-badge status-pending">Pending</span>';
            break;
        case 'processing':
            statusBadge = '<span class="status-badge status-processing">Processing</span>';
            stepCard.classList.add('active-step');
            break;
        case 'completed':
            statusBadge = '<span class="status-badge status-completed">Completed</span>';
            stepCard.classList.add('completed-step');
            break;
        case 'failed':
            statusBadge = '<span class="status-badge status-failed">Failed</span>';
            stepCard.classList.add('failed-step');
            break;
    }
    
    statusElement.innerHTML = statusBadge;
    
    if (message) {
        addStepLog(stepId, message, status);
    }
}

// Add log to specific step
function addStepLog(stepId, message, level = 'info') {
    const logElement = document.getElementById(`${stepId}Log`);
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    logEntry.innerHTML = `
        <div class="log-time">${timestamp}</div>
        <div class="log-message log-${level}">${message}</div>
    `;
    logElement.appendChild(logEntry);
    logElement.scrollTop = logElement.scrollHeight;
}

// Add file to staging step
function addFileToStaging(filename, status = 'pending') {
    const stagingFiles = document.getElementById('stagingFiles');
    // Clear placeholder if it exists
    if (stagingFiles.querySelector('.file-placeholder')) {
        stagingFiles.innerHTML = '';
    }
    
    const fileBadge = document.createElement('div');
    fileBadge.className = `file-badge ${status}`;
    fileBadge.innerHTML = `
        <i class="fas ${
            status === 'completed' ? 'fa-check-circle' : 
            status === 'failed' ? 'fa-exclamation-circle' : 
            status === 'processing' ? 'fa-spinner fa-spin' : 'fa-file'
        }"></i>
        <span>${filename}</span>
    `;
    stagingFiles.appendChild(fileBadge);
}

// Add live log entry
function addLiveLog(message, level = 'info') {
    const liveLogs = document.getElementById('liveLogs');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry live-log-entry';
    logEntry.innerHTML = `
        <div class="log-time">${timestamp}</div>
        <div class="log-message log-${level}">${message}</div>
    `;
    liveLogs.appendChild(logEntry);
    liveLogs.scrollTop = liveLogs.scrollHeight;
    
    if (liveLogs.children.length > 50) {
        liveLogs.removeChild(liveLogs.firstChild);
    }
}

// Update status message
function updateStatusMessage(message, type = 'info') {
    const statusElement = document.getElementById('statusMessage');
    statusElement.textContent = message;
    
    const currentStatus = document.getElementById('currentStatus');
    currentStatus.style.borderLeftColor = 
        type === 'error' ? '#ef4444' : 
        type === 'success' ? '#10b981' : 
        type === 'warning' ? '#f59e0b' : '#3b82f6';
}

// Fetch import status from backend
async function fetchImportStatus() {
    try {
        let url = '/api/import-status';
        if (currentImportId) {
            url += `?import_id=${currentImportId}`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.error) {
            if (data.error === 'Import not found') {
                updateStatusMessage('Import not found or completed', 'warning');
                addLiveLog('Import not found. It may have completed.', 'warning');
            } else {
                updateStatusMessage('Error: ' + data.error, 'error');
                addLiveLog('Error: ' + data.error, 'error');
            }
            return;
        }
        
        let importData;
        if (data.import_id) {
            importData = data;
        } else if (data.active_imports && Object.keys(data.active_imports).length > 0) {
            if (currentImportId && data.active_imports[currentImportId]) {
                importData = data.active_imports[currentImportId];
                importData.import_id = currentImportId;
            } else {
                const firstImportId = Object.keys(data.active_imports)[0];
                importData = data.active_imports[firstImportId];
                importData.import_id = firstImportId;
                currentImportId = firstImportId;
            }
        } else {
            updateStatusMessage('No active imports found', 'info');
            addLiveLog('No active imports found. Upload files to start.', 'info');
            return;
        }
        
        updateProgressFromImportData(importData);
        
    } catch (error) {
        console.error('Error fetching import status:', error);
        updateStatusMessage('Error connecting to server', 'error');
        addLiveLog('Error: ' + error.message, 'error');
    }
}

// Update progress from import data
function updateProgressFromImportData(importData) {
    const { status, current_step, progress, logs, file_types, files } = importData;
    
    updateStatusMessage(current_step, status === 'error' ? 'error' : 'info');
    
    const processedFiles = files ? files.length : (file_types ? file_types.length : 0);
    const completedSteps = progress >= 100 ? 3 : Math.floor(progress / 33);
    
    updateProgressDisplay(processedFiles, completedSteps, 3, progress);
    
    // Update step status based on progress
    if (progress < 30) {
        updateStepStatus('staging', 'processing', 'Processing files...');
        updateStepStatus('final', 'pending');
        updateStepStatus('reconciliation', 'pending');
    } else if (progress < 70) {
        updateStepStatus('staging', 'completed', 'Files processed successfully');
        updateStepStatus('final', 'processing', current_step);
        updateStepStatus('reconciliation', 'pending');
    } else if (progress < 100) {
        updateStepStatus('staging', 'completed', 'Files processed successfully');
        updateStepStatus('final', 'completed', 'Data processing completed');
        updateStepStatus('reconciliation', 'processing', current_step);
    } else {
        updateStepStatus('staging', 'completed', 'Files processed successfully');
        updateStepStatus('final', 'completed', 'Data processing completed');
        updateStepStatus('reconciliation', status === 'success' ? 'completed' : 'failed', current_step);
    }
    
    // Add logs
    if (logs && logs.length > 0) {
        logs.forEach(log => {
            addLiveLog(log.message, log.level);
        });
    }
    
    // Update file badges
    if (files && files.length > 0) {
        files.forEach(filename => {
            addFileToStaging(filename, 'completed');
        });
    } else if (file_types && file_types.length > 0) {
        file_types.forEach(fileType => {
            addFileToStaging(`${fileType.toUpperCase()} File`, 'completed');
        });
    }
    
    // Show completion message
    if (status === 'success' && progress >= 100) {
        updateStatusMessage('Import completed successfully!', 'success');
        showAlert('Import completed successfully!', 'success');
    } else if (status === 'error') {
        updateStatusMessage('Import failed', 'error');
        showAlert('Import failed: ' + current_step, 'error');
    }
}

// Refresh status function
function refreshStatus() {
    const refreshBtn = document.getElementById('refreshBtn');
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing';
    
    fetchImportStatus().finally(() => {
        setTimeout(() => {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        }, 1000);
    });
}

// Toggle auto-refresh
function toggleAutoRefresh() {
    autoRefresh = !autoRefresh;
    if (autoRefresh) {
        startAutoRefresh();
        showAlert('Auto-refresh enabled', 'success');
    } else {
        stopAutoRefresh();
        showAlert('Auto-refresh disabled', 'warning');
    }
}

// Start auto-refresh
function startAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
    refreshInterval = setInterval(fetchImportStatus, 3000);
}

// Stop auto-refresh
function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Set up auto-refresh toggle
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');
    if (autoRefreshToggle) {
        autoRefreshToggle.checked = autoRefresh;
        autoRefreshToggle.addEventListener('change', toggleAutoRefresh);
    }
    
    // Start fetching import status
    fetchImportStatus();
    
    // Set up auto-refresh if enabled
    if (autoRefresh) {
        startAutoRefresh();
    }
    
    // Add initial log
    addLiveLog('Progress monitoring started' + (currentImportId ? ` for import: ${currentImportId}` : ''), 'info');
});

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>
{% endblock %}